# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: cd-prod
on:
  push:
    branches:
      - main
jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.4
          registry-url: https://npm.pkg.github.com
      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
        run: npm ci
      - run: npm test
      - name: Configure AWS credentials for test account
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::848158183973:role/github-actions-role
          aws-region: eu-central-1
      - name: Set CDK stage name for test env
        id: cdk-stage-generator
        run: echo "CDK_TEST_STAGE=test-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Deploy Test Stack
        id: deploy-test
        env:
          CDK_DEPLOY_ACCOUNT: "848158183973"
          CDK_DEPLOY_REGION: eu-central-1
        run: npx projen deploy:test --require-approval never -c stage=${{ steps.cdk-stage-generator.outputs.CDK_TEST_STAGE }}
      - name: Run integ tests
        env:
          CFN_STACK_NAME: ${{ steps.cdk-stage-generator.outputs.CDK_TEST_STAGE }}-back
          TEST_QUEUE_NAME: integ-${{ steps.cdk-stage-generator.outputs.CDK_TEST_STAGE }}
        run: npm run test:integ
      - name: Run e2e tests
        env:
          CFN_STACK_NAME: ${{ steps.cdk-stage-generator.outputs.CDK_TEST_STAGE }}-back
          TEST_QUEUE_NAME: e2e-${{ steps.cdk-stage-generator.outputs.CDK_TEST_STAGE }}
        run: npm run test:e2e
      - name: Destroy test stack
        if: always() && steps.deploy-test.outcome == 'success'
        run: npx cdk destroy --force -c stage=${{ steps.cdk-stage-generator.outputs.CDK_TEST_STAGE }}
  deploy-prod:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.20.4
          registry-url: https://npm.pkg.github.com
      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
        run: npm ci
      - name: Configure AWS credentials for dev account
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::847365307177:role/github-actions-role
          aws-region: eu-central-1
      - id: check-diff
        run: npx cdk diff -c stage=prod --fail
        continue-on-error: true
      - if: steps.check-diff.outcome == 'failure'
        env:
          CDK_DEPLOY_ACCOUNT: "847365307177"
          CDK_DEPLOY_REGION: eu-central-1
        run: npx cdk deploy --require-approval never -c stage=prod --method=direct --all
